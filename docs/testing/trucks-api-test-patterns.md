# Trucks API 動作確認テストパターン

## 概要
`trucks`テーブルのAPI移行後の動作確認用テストパターンです。

## 前提条件
- データベースに`moving_companies`テーブルにテスト用の業者データが存在すること
- テスト用の`company_id`を確認すること（現在は`11111111-1111-1111-1111-111111111111`を使用）

---

## 1. APIエンドポイントの動作確認

### 1.1 GET /api/trucks - トラック一覧取得

#### テストケース 1-1: 全トラック取得
```bash
# リクエスト
GET /api/trucks

# 期待結果
- ステータスコード: 200
- レスポンス: { success: true, data: [...], count: N }
- データが配列で返される
```

#### テストケース 1-2: 業者IDでフィルタ
```bash
# リクエスト
GET /api/trucks?company_id=11111111-1111-1111-1111-111111111111

# 期待結果
- 指定した業者のトラックのみが返される
- 他の業者のトラックは含まれない
```

#### テストケース 1-3: ステータスでフィルタ
```bash
# リクエスト
GET /api/trucks?status=available

# 期待結果
- statusが'available'のトラックのみが返される
```

#### テストケース 1-4: 複数フィルタ
```bash
# リクエスト
GET /api/trucks?company_id=11111111-1111-1111-1111-111111111111&status=available

# 期待結果
- 指定した業者かつ指定したステータスのトラックのみが返される
```

---

### 1.2 POST /api/trucks - トラック作成

#### テストケース 2-1: 正常なトラック作成
```bash
# リクエスト
POST /api/trucks
Content-Type: application/json

{
  "company_id": "11111111-1111-1111-1111-111111111111",
  "truck_number": "TRUCK-001",
  "license_plate": "品川 500 あ 1234",
  "truck_type": "2t",
  "capacity_cbm": 10.5,
  "max_load_kg": 2000,
  "has_lift_gate": true,
  "has_air_conditioning": false,
  "next_inspection_date": "2025-12-31",
  "insurance_expiry_date": "2025-12-31",
  "status": "available"
}

# 期待結果
- ステータスコード: 201
- レスポンス: { success: true, data: {...}, message: "Truck created successfully" }
- 作成されたトラックのIDが返される
- データベースにトラックが保存される
```

#### テストケース 2-2: 必須フィールド不足
```bash
# リクエスト（license_plateを省略）
POST /api/trucks
{
  "company_id": "11111111-1111-1111-1111-111111111111",
  "truck_number": "TRUCK-002",
  "truck_type": "2t",
  ...
}

# 期待結果
- ステータスコード: 400
- エラーメッセージ: "Missing required field: license_plate"
```

#### テストケース 2-3: ナンバープレート重複
```bash
# リクエスト（既存のlicense_plateを使用）
POST /api/trucks
{
  "company_id": "11111111-1111-1111-1111-111111111111",
  "truck_number": "TRUCK-003",
  "license_plate": "品川 500 あ 1234",  // 既に存在するナンバー
  ...
}

# 期待結果
- ステータスコード: 409
- エラーメッセージ: "License plate already exists"
```

#### テストケース 2-4: 業者内でのトラック番号重複
```bash
# リクエスト（同じ業者内で既存のtruck_numberを使用）
POST /api/trucks
{
  "company_id": "11111111-1111-1111-1111-111111111111",
  "truck_number": "TRUCK-001",  // 既に存在する番号
  "license_plate": "品川 500 い 5678",
  ...
}

# 期待結果
- ステータスコード: 409
- エラーメッセージ: "Truck number already exists for this company"
```

---

### 1.3 GET /api/trucks/[id] - 特定トラック取得

#### テストケース 3-1: 存在するトラック取得
```bash
# リクエスト
GET /api/trucks/{truck_id}

# 期待結果
- ステータスコード: 200
- レスポンス: { success: true, data: {...} }
- 指定したIDのトラック情報が返される
```

#### テストケース 3-2: 存在しないトラック取得
```bash
# リクエスト
GET /api/trucks/00000000-0000-0000-0000-000000000000

# 期待結果
- ステータスコード: 404
- エラーメッセージ: "Truck not found"
```

---

### 1.4 PUT /api/trucks/[id] - トラック更新

#### テストケース 4-1: 正常な更新
```bash
# リクエスト
PUT /api/trucks/{truck_id}
Content-Type: application/json

{
  "truck_number": "TRUCK-001-UPDATED",
  "status": "maintenance"
}

# 期待結果
- ステータスコード: 200
- レスポンス: { success: true, data: {...}, message: "Truck updated successfully" }
- データベースのトラック情報が更新される
```

#### テストケース 4-2: 存在しないトラック更新
```bash
# リクエスト
PUT /api/trucks/00000000-0000-0000-0000-000000000000

# 期待結果
- ステータスコード: 404
- エラーメッセージ: "Truck not found"
```

#### テストケース 4-3: ナンバープレート重複（更新時）
```bash
# リクエスト（他のトラックが使用しているlicense_plateに変更）
PUT /api/trucks/{truck_id}
{
  "license_plate": "品川 500 あ 1234"  // 他のトラックが使用中
}

# 期待結果
- ステータスコード: 409
- エラーメッセージ: "License plate already exists"
```

---

### 1.5 DELETE /api/trucks/[id] - トラック削除

#### テストケース 5-1: 正常な削除
```bash
# リクエスト
DELETE /api/trucks/{truck_id}

# 期待結果
- ステータスコード: 200
- レスポンス: { success: true, message: "Truck deleted successfully" }
- データベースからトラックが削除される（またはstatusが'retired'になる）
```

#### テストケース 5-2: 存在しないトラック削除
```bash
# リクエスト
DELETE /api/trucks/00000000-0000-0000-0000-000000000000

# 期待結果
- ステータスコード: 404
- エラーメッセージ: "Truck not found"
```

#### テストケース 5-3: 外部キー制約がある場合の削除
```bash
# リクエスト（jobsやshiftsなどで参照されているトラックを削除）
DELETE /api/trucks/{truck_id_with_references}

# 期待結果
- 物理削除が失敗した場合、論理削除（status = 'retired'）が実行される
- レスポンス: { success: true, message: "Truck retired successfully..." }
```

---

## 2. フロントエンド画面の動作確認

### 2.1 配車管理画面（/admin/dispatch）の基本動作

#### テストケース 6-1: 画面表示
1. `/admin/dispatch`にアクセス
2. **期待結果**:
   - 画面が正常に表示される
   - トラック一覧が表示される（APIから取得）
   - ローディング状態が適切に表示される

#### テストケース 6-2: トラック一覧の取得
1. 画面を開く
2. **期待結果**:
   - APIからトラック一覧が取得される
   - トラックがテーブルまたはカレンダーに表示される
   - エラー時は適切なエラーメッセージが表示される

---

### 2.2 トラック管理タブ

#### テストケース 7-1: トラック作成
1. `/admin/dispatch`にアクセス
2. 「トラック管理」タブを選択
3. 「新規登録」ボタンをクリック
4. 以下の情報を入力:
   - トラック番号: `TRUCK-TEST-001`
   - ナンバープレート: `品川 500 あ TEST1`
   - 車種: `2t`
   - 容量（kg）: `2000`
   - 容量（CBM）: `10.5`
   - 次回車検日: `2025-12-31`
   - 保険有効期限: `2025-12-31`
   - ステータス: `available`
5. 「保存」ボタンをクリック
6. **期待結果**:
   - トラックが作成される
   - 一覧に新しいトラックが表示される
   - 成功メッセージが表示される（またはエラーがない）

#### テストケース 7-2: トラック編集
1. 既存のトラックを選択
2. 「編集」ボタンをクリック
3. トラック番号を変更: `TRUCK-TEST-001-UPDATED`
4. 「保存」ボタンをクリック
5. **期待結果**:
   - トラック情報が更新される
   - 一覧に変更が反映される
   - 成功メッセージが表示される

#### テストケース 7-3: トラック削除
1. 既存のトラックを選択
2. 「削除」ボタンをクリック
3. 確認ダイアログで「OK」をクリック
4. **期待結果**:
   - トラックが削除される（またはstatusが'retired'になる）
   - 一覧からトラックが消える
   - 成功メッセージが表示される

#### テストケース 7-4: バリデーションエラー
1. トラック作成フォームを開く
2. 必須フィールドを空のまま「保存」をクリック
3. **期待結果**:
   - バリデーションエラーが表示される
   - エラーメッセージが適切に表示される
   - トラックが作成されない

#### テストケース 7-5: ナンバープレート重複エラー
1. 既存のトラックと同じナンバープレートで新規作成を試みる
2. **期待結果**:
   - エラーメッセージ: "ナンバープレートが既に存在します"（または類似）
   - トラックが作成されない

---

### 2.3 配車カレンダータブ

#### テストケース 8-1: トラック表示
1. 「配車カレンダー」タブを選択
2. **期待結果**:
   - トラックがカレンダーに表示される
   - トラック名（truckType + licensePlate）が表示される
   - 容量（maxLoadKg）が表示される

#### テストケース 8-2: トラック割り当て
1. 案件を選択
2. トラックを割り当て
3. **期待結果**:
   - トラックが案件に割り当てられる
   - 容量チェックが正常に動作する（maxLoadKgを使用）
   - 成功メッセージが表示される

#### テストケース 8-3: 容量超過エラー
1. トラックの`maxLoadKg`を超える容量の案件を割り当てようとする
2. **期待結果**:
   - エラーメッセージ: "容量超過: XXXkg > YYYkg"
   - 割り当てが実行されない

---

## 3. エラーハンドリングの確認

#### テストケース 9-1: ネットワークエラー
1. 開発者ツールでネットワークをオフラインにする
2. トラック一覧を取得しようとする
3. **期待結果**:
   - エラーメッセージが表示される
   - ユーザーに分かりやすいメッセージが表示される

#### テストケース 9-2: APIエラー（500エラーなど）
1. サーバー側でエラーを発生させる
2. **期待結果**:
   - エラーメッセージが表示される
   - コンソールにエラーログが出力される

---

## 4. データ整合性の確認

#### テストケース 10-1: 日付フォーマット
1. トラックを作成・更新
2. **期待結果**:
   - 日付フィールド（nextInspectionDate, insuranceExpiryDate）が正しいフォーマットで保存される
   - フロントエンドで正しく表示される

#### テストケース 10-2: 数値フィールド
1. トラックを作成・更新
2. **期待結果**:
   - 数値フィールド（capacityCbm, maxLoadKg, fuelEfficiencyKmpl）が正しく保存される
   - フロントエンドで正しく表示される

#### テストケース 10-3: オプションフィールド
1. オプションフィールド（manufactureYear, manufacturer, modelNameなど）を空で作成
2. **期待結果**:
   - nullとして正しく保存される
   - フロントエンドでundefinedとして扱われる

---

## 5. パフォーマンス確認

#### テストケース 11-1: 大量データの取得
1. 100件以上のトラックを作成
2. トラック一覧を取得
3. **期待結果**:
   - レスポンス時間が許容範囲内
   - 画面がフリーズしない

---

## 6. ブラウザ互換性確認

#### テストケース 12-1: 主要ブラウザでの動作
1. Chrome, Firefox, Safari, Edgeで動作確認
2. **期待結果**:
   - すべてのブラウザで正常に動作する

---

## チェックリスト

### APIエンドポイント
- [ ] GET /api/trucks - 全トラック取得
- [ ] GET /api/trucks?company_id=... - 業者IDでフィルタ
- [ ] GET /api/trucks?status=... - ステータスでフィルタ
- [ ] POST /api/trucks - トラック作成（正常系）
- [ ] POST /api/trucks - 必須フィールド不足エラー
- [ ] POST /api/trucks - ナンバープレート重複エラー
- [ ] POST /api/trucks - トラック番号重複エラー
- [ ] GET /api/trucks/[id] - 存在するトラック取得
- [ ] GET /api/trucks/[id] - 存在しないトラック取得
- [ ] PUT /api/trucks/[id] - トラック更新（正常系）
- [ ] PUT /api/trucks/[id] - 存在しないトラック更新
- [ ] PUT /api/trucks/[id] - ナンバープレート重複エラー
- [ ] DELETE /api/trucks/[id] - トラック削除（正常系）
- [ ] DELETE /api/trucks/[id] - 存在しないトラック削除

### フロントエンド画面
- [ ] 画面表示（/admin/dispatch）
- [ ] トラック一覧の取得と表示
- [ ] トラック作成
- [ ] トラック編集
- [ ] トラック削除
- [ ] バリデーションエラー表示
- [ ] ナンバープレート重複エラー表示
- [ ] 配車カレンダーでのトラック表示
- [ ] トラック割り当て
- [ ] 容量超過エラー表示
- [ ] エラーハンドリング（ネットワークエラー）
- [ ] エラーハンドリング（APIエラー）

### データ整合性
- [ ] 日付フォーマット
- [ ] 数値フィールド
- [ ] オプションフィールド

---

## 注意事項

1. **company_id**: 現在は`11111111-1111-1111-1111-111111111111`をハードコードしていますが、実際の環境では認証情報から取得する必要があります。

2. **schedules**: 現在は空配列で初期化しています。実際のスケジュールデータは`jobs`や`shifts`テーブルから取得する必要があります。

3. **テストデータ**: テスト後にテストデータを削除することを推奨します。

4. **外部キー制約**: トラックを削除する際、`jobs`や`shifts`などで参照されている場合は論理削除（status = 'retired'）が実行されます。

