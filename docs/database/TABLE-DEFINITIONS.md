# ğŸ“š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©æ›¸ï¼ˆå®Œå…¨ç‰ˆï¼‰

## ç›®æ¬¡

### 1. ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
- [1.1 usersï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰](#11-usersãƒ¦ãƒ¼ã‚¶ãƒ¼)
- [1.2 moving_companiesï¼ˆå¼•è¶Šã—æ¥­è€…ï¼‰](#12-moving_companieså¼•è¶Šã—æ¥­è€…)

### 2. å¾“æ¥­å“¡ãƒ»ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†
- [2.1 employeesï¼ˆå¾“æ¥­å“¡ï¼‰](#21-employeeså¾“æ¥­å“¡)
- [2.2 trucksï¼ˆãƒˆãƒ©ãƒƒã‚¯ï¼‰](#22-trucksãƒˆãƒ©ãƒƒã‚¯)
- [2.3 shiftsï¼ˆã‚·ãƒ•ãƒˆï¼‰](#23-shiftsã‚·ãƒ•ãƒˆ)

### 3. ä¸å‹•ç”£ãƒ»ç´¹ä»‹è€…ç®¡ç†
- [3.1 real_estate_agentsï¼ˆä¸å‹•ç”£ä»²ä»‹æ¥­è€…ï¼‰](#31-real_estate_agentsä¸å‹•ç”£ä»²ä»‹æ¥­è€…)
- [3.2 referrersï¼ˆç´¹ä»‹è€…ï¼‰](#32-referrersç´¹ä»‹è€…)
- [3.3 referral_casesï¼ˆç´¹ä»‹æ¡ˆä»¶ï¼‰](#33-referral_casesç´¹ä»‹æ¡ˆä»¶)

### 4. è¦‹ç©ä¾é ¼ãƒ•ãƒ­ãƒ¼
- [4.1 quote_requestsï¼ˆè¦‹ç©ä¾é ¼ï¼‰](#41-quote_requestsè¦‹ç©ä¾é ¼)
- [4.2 moving_itemsï¼ˆå¼•è¶Šã—è·ç‰©ï¼‰](#42-moving_itemså¼•è¶Šã—è·ç‰©)
- [4.3 quotesï¼ˆè¦‹ç©ï¼‰](#43-quotesè¦‹ç©)
- [4.4 quote_optionsï¼ˆè¦‹ç©ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰](#44-quote_optionsè¦‹ç©ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

### 5. æ¡ˆä»¶ç®¡ç†
- [5.1 jobsï¼ˆæ¡ˆä»¶ï¼‰](#51-jobsæ¡ˆä»¶)
- [5.2 job_assignmentsï¼ˆæ¡ˆä»¶å‰²ã‚Šå½“ã¦ï¼‰](#52-job_assignmentsæ¡ˆä»¶å‰²ã‚Šå½“ã¦)
- [5.3 reviewsï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰](#53-reviewsãƒ¬ãƒ“ãƒ¥ãƒ¼)

### 6. ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿
- [6.1 item_mastersï¼ˆè·ç‰©ãƒã‚¹ã‚¿ï¼‰](#61-item_mastersè·ç‰©ãƒã‚¹ã‚¿)
- [6.2 pricing_rulesï¼ˆæ–™é‡‘ãƒ«ãƒ¼ãƒ«ï¼‰](#62-pricing_rulesæ–™é‡‘ãƒ«ãƒ¼ãƒ«)
- [6.3 optionsï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰](#63-optionsã‚ªãƒ—ã‚·ãƒ§ãƒ³)
- [6.4 season_rulesï¼ˆã‚·ãƒ¼ã‚ºãƒ³åŠ ç®—ãƒ«ãƒ¼ãƒ«ï¼‰](#64-season_rulesã‚·ãƒ¼ã‚ºãƒ³åŠ ç®—ãƒ«ãƒ¼ãƒ«)

### 7. ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½
- [7.1 notificationsï¼ˆé€šçŸ¥ï¼‰](#71-notificationsé€šçŸ¥)

---

## 1. ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

### 1.1 usersï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `users`

**èª¬æ˜**: ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®èªè¨¼åŸºç›¤ã€‚é¡§å®¢ã€æ¥­è€…ã‚ªãƒ¼ãƒŠãƒ¼ã€å¾“æ¥­å“¡ã€ç®¡ç†è€…ã€ä¸å‹•ç”£æ¥­è€…ãªã©å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’çµ±åˆç®¡ç†ã€‚

**DDL**:
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- èªè¨¼æƒ…å ±
  email VARCHAR(255) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,

  -- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
  name VARCHAR(100) NOT NULL,
  role VARCHAR(20) NOT NULL
    CHECK (role IN ('customer', 'business_owner', 'employee', 'admin', 'agent')),

  -- é–¢é€£ID
  moving_company_id UUID REFERENCES moving_companies(id),
  employee_id UUID REFERENCES employees(id),
  real_estate_agent_id UUID REFERENCES real_estate_agents(id),

  -- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹
  is_active BOOLEAN NOT NULL DEFAULT true,
  email_verified BOOLEAN NOT NULL DEFAULT false,
  email_verified_at TIMESTAMP,

  -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
  last_login_at TIMESTAMP,
  password_reset_token VARCHAR(255),
  password_reset_expires_at TIMESTAMP,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_active ON users(is_active) WHERE is_active = true;
CREATE INDEX idx_users_company ON users(moving_company_id);
```

**ã‚«ãƒ©ãƒ å®šç¾©**:

| # | ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---------|---|------|----------|------|
| 1 | id | UUID | NOT NULL | gen_random_uuid() | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| 2 | email | VARCHAR(255) | NOT NULL | - | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒ­ã‚°ã‚¤ãƒ³IDï¼‰ |
| 3 | password_hash | VARCHAR(255) | NOT NULL | - | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ï¼ˆbcryptç­‰ï¼‰ |
| 4 | name | VARCHAR(100) | NOT NULL | - | æ°å |
| 5 | role | VARCHAR(20) | NOT NULL | - | å½¹å‰²ï¼ˆcustomer/business_owner/employee/admin/agentï¼‰ |
| 6 | moving_company_id | UUID | NULL | - | æ‰€å±å¼•è¶Šã—æ¥­è€…IDï¼ˆFKï¼‰ |
| 7 | employee_id | UUID | NULL | - | å¾“æ¥­å“¡IDï¼ˆFKï¼‰ |
| 8 | real_estate_agent_id | UUID | NULL | - | ä¸å‹•ç”£æ¥­è€…IDï¼ˆFKï¼‰ |
| 9 | is_active | BOOLEAN | NOT NULL | true | æœ‰åŠ¹ãƒ•ãƒ©ã‚° |
| 10 | email_verified | BOOLEAN | NOT NULL | false | ãƒ¡ãƒ¼ãƒ«èªè¨¼æ¸ˆã¿ãƒ•ãƒ©ã‚° |
| 11 | email_verified_at | TIMESTAMP | NULL | - | ãƒ¡ãƒ¼ãƒ«èªè¨¼æ—¥æ™‚ |
| 12 | last_login_at | TIMESTAMP | NULL | - | æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ |
| 13 | password_reset_token | VARCHAR(255) | NULL | - | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ |
| 14 | password_reset_expires_at | TIMESTAMP | NULL | - | ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ |
| 15 | created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | ä½œæˆæ—¥æ™‚ |
| 16 | updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¥æ™‚ |

**åˆ¶ç´„**:
- **PRIMARY KEY**: `id`
- **UNIQUE**: `email`
- **CHECK**: `role IN ('customer', 'business_owner', 'employee', 'admin', 'agent')`

**å¤–éƒ¨ã‚­ãƒ¼**:
- `moving_company_id` â†’ `moving_companies(id)`
- `employee_id` â†’ `employees(id)`
- `real_estate_agent_id` â†’ `real_estate_agents(id)`

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_users_email`: emailï¼ˆãƒ­ã‚°ã‚¤ãƒ³é«˜é€ŸåŒ–ï¼‰
- `idx_users_role`: roleï¼ˆãƒ­ãƒ¼ãƒ«åˆ¥æ¤œç´¢ï¼‰
- `idx_users_active`: is_active WHERE is_active = trueï¼ˆæœ‰åŠ¹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ï¼‰
- `idx_users_company`: moving_company_idï¼ˆæ¥­è€…åˆ¥æ¤œç´¢ï¼‰

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ä¸€æ„
- roleã«å¿œã˜ã¦é–¢é€£IDã‚’è¨­å®šï¼ˆbusiness_owner â†’ moving_company_idå¿…é ˆï¼‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã¯1æ™‚é–“ã§å¤±åŠ¹
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯bcryptã§ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆã‚¹ãƒˆãƒ¬ãƒƒãƒãƒ³ã‚°å›æ•°10ä»¥ä¸Šï¼‰

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/business/index.ts:8-44`

---

### 1.2 moving_companiesï¼ˆå¼•è¶Šã—æ¥­è€…ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `moving_companies`

**èª¬æ˜**: å¼•è¶Šã—æ¥­è€…ã®åŸºæœ¬æƒ…å ±ã‚’ç®¡ç†ã€‚

**DDL**:
```sql
CREATE TABLE moving_companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- åŸºæœ¬æƒ…å ±
  name VARCHAR(150) NOT NULL,
  phone VARCHAR(20),
  email VARCHAR(255),
  address VARCHAR(255),

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  is_active BOOLEAN NOT NULL DEFAULT true,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_moving_companies_active ON moving_companies(is_active) WHERE is_active = true;
CREATE INDEX idx_moving_companies_name ON moving_companies(name);
```

**ã‚«ãƒ©ãƒ å®šç¾©**:

| # | ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---------|---|------|----------|------|
| 1 | id | UUID | NOT NULL | gen_random_uuid() | æ¥­è€…IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| 2 | name | VARCHAR(150) | NOT NULL | - | æ¥­è€…å |
| 3 | phone | VARCHAR(20) | NULL | - | é›»è©±ç•ªå· |
| 4 | email | VARCHAR(255) | NULL | - | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| 5 | address | VARCHAR(255) | NULL | - | ä½æ‰€ |
| 6 | is_active | BOOLEAN | NOT NULL | true | æœ‰åŠ¹ãƒ•ãƒ©ã‚° |
| 7 | created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | ä½œæˆæ—¥æ™‚ |
| 8 | updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¥æ™‚ |

**åˆ¶ç´„**:
- **PRIMARY KEY**: `id`

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_moving_companies_active`: is_active WHERE is_active = true
- `idx_moving_companies_name`: name

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- æ¥­è€…å‰Šé™¤æ™‚ã¯è«–ç†å‰Šé™¤ï¼ˆis_active = falseï¼‰ã‚’æ¨å¥¨
- å¾“æ¥­å“¡ãƒ»ãƒˆãƒ©ãƒƒã‚¯ã¨ã®é–¢é€£ãŒã‚ã‚‹å ´åˆã¯ç‰©ç†å‰Šé™¤ä¸å¯

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/business/index.ts:47-63`

---

## 2. å¾“æ¥­å“¡ãƒ»ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†

### 2.1 employeesï¼ˆå¾“æ¥­å“¡ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `employees`

**èª¬æ˜**: å¼•è¶Šã—æ¥­è€…ã®å¾“æ¥­å“¡æƒ…å ±ã‚’ç®¡ç†ã€‚ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã€ä½œæ¥­å“¡ã€ãƒªãƒ¼ãƒ€ãƒ¼ã€ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãªã©ã€‚

**DDL**:
```sql
CREATE TABLE employees (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  moving_company_id UUID NOT NULL REFERENCES moving_companies(id) ON DELETE CASCADE,

  -- åŸºæœ¬æƒ…å ±
  name VARCHAR(100) NOT NULL,
  email VARCHAR(255),
  phone VARCHAR(20),

  -- é›‡ç”¨æƒ…å ±
  role VARCHAR(20) NOT NULL
    CHECK (role IN ('driver', 'staff', 'leader', 'manager')),
  position VARCHAR(50),
  employment_type VARCHAR(30)
    CHECK (employment_type IN ('æ­£ç¤¾å“¡', 'ãƒ‘ãƒ¼ãƒˆ', 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ', 'å¥‘ç´„ç¤¾å“¡')),

  -- æ—¥ä»˜æƒ…å ±
  hire_date DATE NOT NULL,
  retire_date DATE,
  birth_date DATE,

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status VARCHAR(20) NOT NULL DEFAULT 'active'
    CHECK (status IN ('active', 'inactive', 'suspended')),
  is_active BOOLEAN GENERATED ALWAYS AS (status = 'active') STORED,

  -- ãã®ä»–æƒ…å ±
  address VARCHAR(255),
  emergency_contact VARCHAR(100),
  qualifications TEXT,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_employees_company ON employees(moving_company_id);
CREATE INDEX idx_employees_status ON employees(status) WHERE status = 'active';
CREATE INDEX idx_employees_role ON employees(role);
CREATE INDEX idx_employees_email ON employees(email);
```

**ã‚«ãƒ©ãƒ å®šç¾©**:

| # | ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---------|---|------|----------|------|
| 1 | id | UUID | NOT NULL | gen_random_uuid() | å¾“æ¥­å“¡IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| 2 | moving_company_id | UUID | NOT NULL | - | æ‰€å±æ¥­è€…IDï¼ˆFKï¼‰ |
| 3 | name | VARCHAR(100) | NOT NULL | - | æ°å |
| 4 | email | VARCHAR(255) | NULL | - | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| 5 | phone | VARCHAR(20) | NULL | - | é›»è©±ç•ªå· |
| 6 | role | VARCHAR(20) | NOT NULL | - | å½¹å‰²ï¼ˆdriver/staff/leader/managerï¼‰ |
| 7 | position | VARCHAR(50) | NULL | - | å½¹è· |
| 8 | employment_type | VARCHAR(30) | NULL | - | é›‡ç”¨å½¢æ…‹ |
| 9 | hire_date | DATE | NOT NULL | - | å…¥ç¤¾æ—¥ |
| 10 | retire_date | DATE | NULL | - | é€€è·æ—¥ |
| 11 | birth_date | DATE | NULL | - | ç”Ÿå¹´æœˆæ—¥ |
| 12 | status | VARCHAR(20) | NOT NULL | 'active' | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| 13 | is_active | BOOLEAN | GENERATED | - | æœ‰åŠ¹ãƒ•ãƒ©ã‚°ï¼ˆè¨ˆç®—ã‚«ãƒ©ãƒ ï¼‰ |
| 14 | address | VARCHAR(255) | NULL | - | ä½æ‰€ |
| 15 | emergency_contact | VARCHAR(100) | NULL | - | ç·Šæ€¥é€£çµ¡å…ˆ |
| 16 | qualifications | TEXT | NULL | - | ä¿æœ‰è³‡æ ¼ |
| 17 | created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | ä½œæˆæ—¥æ™‚ |
| 18 | updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¥æ™‚ |

**åˆ¶ç´„**:
- **PRIMARY KEY**: `id`
- **FOREIGN KEY**: `moving_company_id` â†’ `moving_companies(id)` ON DELETE CASCADE
- **CHECK**: `role IN ('driver', 'staff', 'leader', 'manager')`
- **CHECK**: `employment_type IN ('æ­£ç¤¾å“¡', 'ãƒ‘ãƒ¼ãƒˆ', 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ', 'å¥‘ç´„ç¤¾å“¡')`
- **CHECK**: `status IN ('active', 'inactive', 'suspended')`
- **GENERATED**: `is_active AS (status = 'active')`

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_employees_company`: moving_company_id
- `idx_employees_status`: status WHERE status = 'active'
- `idx_employees_role`: role
- `idx_employees_email`: email

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- é€€è·æ—¥ãŒè¨­å®šã•ã‚ŒãŸã‚‰statusã‚’inactiveã«å¤‰æ›´
- ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¯é‹è»¢å…è¨±è¨¼æƒ…å ±ã‚’qualificationsã«è¨˜è¼‰
- role='driver'ã®å ´åˆã€qualificationsã«é‹è»¢å…è¨±è¨¼ç•ªå·å¿…é ˆ

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/employee.ts:17-32`, `src/types/shared.ts:7-24`

---

### 2.2 trucksï¼ˆãƒˆãƒ©ãƒƒã‚¯ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `trucks`

**èª¬æ˜**: å¼•è¶Šã—æ¥­è€…ãŒæ‰€æœ‰ã™ã‚‹ãƒˆãƒ©ãƒƒã‚¯æƒ…å ±ã‚’ç®¡ç†ã€‚

**DDL**:
```sql
CREATE TABLE trucks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  moving_company_id UUID NOT NULL REFERENCES moving_companies(id) ON DELETE CASCADE,

  -- åŸºæœ¬æƒ…å ±
  name VARCHAR(100) NOT NULL,
  plate_number VARCHAR(50),
  truck_type VARCHAR(30) NOT NULL
    CHECK (truck_type IN ('è»½ãƒˆãƒ©ãƒƒã‚¯', '2tã‚·ãƒ§ãƒ¼ãƒˆ', '2tãƒ­ãƒ³ã‚°', '4t', '10t')),

  -- å®¹é‡æƒ…å ±
  capacity_kg INT NOT NULL CHECK (capacity_kg > 0),
  capacity_points INT CHECK (capacity_points >= 0),

  -- è»Šæ¤œæƒ…å ±
  inspection_expiry DATE NOT NULL,

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status VARCHAR(20) NOT NULL DEFAULT 'available'
    CHECK (status IN ('available', 'in_use', 'maintenance', 'inactive', 'retired')),

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_trucks_company ON trucks(moving_company_id);
CREATE INDEX idx_trucks_status ON trucks(status) WHERE status IN ('available', 'in_use');
CREATE INDEX idx_trucks_plate ON trucks(plate_number);
CREATE INDEX idx_trucks_inspection ON trucks(inspection_expiry);
```

**ã‚«ãƒ©ãƒ å®šç¾©**:

| # | ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---------|---|------|----------|------|
| 1 | id | UUID | NOT NULL | gen_random_uuid() | ãƒˆãƒ©ãƒƒã‚¯IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| 2 | moving_company_id | UUID | NOT NULL | - | æ‰€å±æ¥­è€…IDï¼ˆFKï¼‰ |
| 3 | name | VARCHAR(100) | NOT NULL | - | ãƒˆãƒ©ãƒƒã‚¯å/è­˜åˆ¥å |
| 4 | plate_number | VARCHAR(50) | NULL | - | ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆ |
| 5 | truck_type | VARCHAR(30) | NOT NULL | - | ãƒˆãƒ©ãƒƒã‚¯ç¨®åˆ¥ |
| 6 | capacity_kg | INT | NOT NULL | - | ç©è¼‰å®¹é‡ï¼ˆkgï¼‰ |
| 7 | capacity_points | INT | NULL | - | ç©è¼‰å®¹é‡ï¼ˆãƒã‚¤ãƒ³ãƒˆï¼‰ |
| 8 | inspection_expiry | DATE | NOT NULL | - | è»Šæ¤œæœ‰åŠ¹æœŸé™ |
| 9 | status | VARCHAR(20) | NOT NULL | 'available' | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| 10 | created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | ä½œæˆæ—¥æ™‚ |
| 11 | updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¥æ™‚ |

**åˆ¶ç´„**:
- **PRIMARY KEY**: `id`
- **FOREIGN KEY**: `moving_company_id` â†’ `moving_companies(id)` ON DELETE CASCADE
- **CHECK**: `truck_type IN ('è»½ãƒˆãƒ©ãƒƒã‚¯', '2tã‚·ãƒ§ãƒ¼ãƒˆ', '2tãƒ­ãƒ³ã‚°', '4t', '10t')`
- **CHECK**: `status IN ('available', 'in_use', 'maintenance', 'inactive', 'retired')`
- **CHECK**: `capacity_kg > 0`
- **CHECK**: `capacity_points >= 0`

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_trucks_company`: moving_company_id
- `idx_trucks_status`: status WHERE status IN ('available', 'in_use')
- `idx_trucks_plate`: plate_number
- `idx_trucks_inspection`: inspection_expiry

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- è»Šæ¤œæœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚ŒãŸãƒˆãƒ©ãƒƒã‚¯ã¯è‡ªå‹•çš„ã«statusã‚’maintenanceã«å¤‰æ›´
- capacity_pointsã¯è¦‹ç©ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºç”¨ï¼ˆè·ç‰©ã®ç·ãƒã‚¤ãƒ³ãƒˆ â‰¤ capacity_pointsï¼‰
- truck_typeã¨ä¸€èˆ¬çš„ãªå®¹é‡ã®å¯¾å¿œ:
  - è»½ãƒˆãƒ©ãƒƒã‚¯: 350kg
  - 2tã‚·ãƒ§ãƒ¼ãƒˆ: 2,000kg
  - 2tãƒ­ãƒ³ã‚°: 2,000kg
  - 4t: 4,000kg
  - 10t: 10,000kg

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/shared.ts:66-75`, `src/types/unified.ts:49-59`

---

### 2.3 shiftsï¼ˆã‚·ãƒ•ãƒˆï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `shifts`

**èª¬æ˜**: å¾“æ¥­å“¡ã®ã‚·ãƒ•ãƒˆæƒ…å ±ã‚’ç®¡ç†ã€‚æ¡ˆä»¶ã¸ã®å‰²ã‚Šå½“ã¦ã‚‚å«ã‚€ã€‚

**DDL**:
```sql
CREATE TABLE shifts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  employee_id UUID NOT NULL REFERENCES employees(id) ON DELETE CASCADE,

  -- ã‚·ãƒ•ãƒˆæ—¥æ™‚
  date DATE NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  time_slot VARCHAR(50),

  -- å‰²ã‚Šå½“ã¦æƒ…å ±
  job_id UUID REFERENCES jobs(id) ON DELETE SET NULL,
  truck_id UUID REFERENCES trucks(id) ON DELETE SET NULL,

  -- ä½œæ¥­æƒ…å ±
  customer_name VARCHAR(100),
  work_type VARCHAR(30)
    CHECK (work_type IN ('loading', 'moving', 'unloading', 'maintenance', 'other')),

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status VARCHAR(20) NOT NULL DEFAULT 'planned'
    CHECK (status IN ('available', 'planned', 'assigned', 'booked',
                     'working', 'completed', 'cancelled', 'unavailable', 'overtime')),

  -- å‚™è€ƒ
  notes TEXT,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  -- æ—¥ãƒã‚¿ã‚®å¯¾å¿œã®æ¤œè¨¼
  CONSTRAINT check_time_valid
    CHECK (start_time < end_time OR (start_time > end_time AND time_slot IS NOT NULL))
);

CREATE INDEX idx_shifts_employee ON shifts(employee_id, date);
CREATE INDEX idx_shifts_date ON shifts(date);
CREATE INDEX idx_shifts_job ON shifts(job_id);
CREATE INDEX idx_shifts_truck ON shifts(truck_id);
CREATE INDEX idx_shifts_status ON shifts(status);
```

**ã‚«ãƒ©ãƒ å®šç¾©**:

| # | ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---------|---|------|----------|------|
| 1 | id | UUID | NOT NULL | gen_random_uuid() | ã‚·ãƒ•ãƒˆIDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| 2 | employee_id | UUID | NOT NULL | - | å¾“æ¥­å“¡IDï¼ˆFKï¼‰ |
| 3 | date | DATE | NOT NULL | - | ã‚·ãƒ•ãƒˆæ—¥ |
| 4 | start_time | TIME | NOT NULL | - | é–‹å§‹æ™‚åˆ» |
| 5 | end_time | TIME | NOT NULL | - | çµ‚äº†æ™‚åˆ» |
| 6 | time_slot | VARCHAR(50) | NULL | - | æ™‚é–“å¸¯IDï¼ˆ30åˆ†å˜ä½ï¼‰ |
| 7 | job_id | UUID | NULL | - | å‰²ã‚Šå½“ã¦æ¡ˆä»¶IDï¼ˆFKï¼‰ |
| 8 | truck_id | UUID | NULL | - | å‰²ã‚Šå½“ã¦ãƒˆãƒ©ãƒƒã‚¯IDï¼ˆFKï¼‰ |
| 9 | customer_name | VARCHAR(100) | NULL | - | é¡§å®¢å |
| 10 | work_type | VARCHAR(30) | NULL | - | ä½œæ¥­ç¨®åˆ¥ |
| 11 | status | VARCHAR(20) | NOT NULL | 'planned' | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| 12 | notes | TEXT | NULL | - | å‚™è€ƒ |
| 13 | created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | ä½œæˆæ—¥æ™‚ |
| 14 | updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¥æ™‚ |

**åˆ¶ç´„**:
- **PRIMARY KEY**: `id`
- **FOREIGN KEY**: `employee_id` â†’ `employees(id)` ON DELETE CASCADE
- **FOREIGN KEY**: `job_id` â†’ `jobs(id)` ON DELETE SET NULL
- **FOREIGN KEY**: `truck_id` â†’ `trucks(id)` ON DELETE SET NULL
- **CHECK**: `work_type IN ('loading', 'moving', 'unloading', 'maintenance', 'other')`
- **CHECK**: `status IN ('available', 'planned', 'assigned', 'booked', 'working', 'completed', 'cancelled', 'unavailable', 'overtime')`
- **CHECK**: `check_time_valid` - æ—¥ãƒã‚¿ã‚®å¯¾å¿œã®æ™‚é–“æ¤œè¨¼

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_shifts_employee`: (employee_id, date)
- `idx_shifts_date`: date
- `idx_shifts_job`: job_id
- `idx_shifts_truck`: truck_id
- `idx_shifts_status`: status

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- time_slotã¯00:00-24:00ã®30åˆ†å˜ä½ï¼ˆ48ã‚¹ãƒ­ãƒƒãƒˆï¼‰
- æ—¥ãƒã‚¿ã‚®ã‚·ãƒ•ãƒˆï¼ˆ23:00-02:00ç­‰ï¼‰ã¯time_slotå¿…é ˆ
- job_idãŒNULLã§ãªã„ã‚·ãƒ•ãƒˆã¯ã€Œæ¡ˆä»¶å‰²ã‚Šå½“ã¦æ¸ˆã¿ã€
- statusã®é·ç§»: planned â†’ assigned â†’ working â†’ completed
- statusãŒavailableã®å ´åˆã€job_idã¯NULL

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/shared.ts:53-63`, `src/types/employee.ts:5-15`, `src/constants/calendar.ts`

---

## 3. ä¸å‹•ç”£ãƒ»ç´¹ä»‹è€…ç®¡ç†

### 3.1 real_estate_agentsï¼ˆä¸å‹•ç”£ä»²ä»‹æ¥­è€…ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `real_estate_agents`

**èª¬æ˜**: ä¸å‹•ç”£ä»²ä»‹æ¥­è€…ã®æƒ…å ±ã‚’ç®¡ç†ã€‚ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ç™ºè¡Œã¨æ¡ˆä»¶ç´¹ä»‹ã«ä½¿ç”¨ã€‚

**DDL**:
```sql
CREATE TABLE real_estate_agents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ä¼šç¤¾æƒ…å ±
  company_name VARCHAR(150) NOT NULL,
  license_no VARCHAR(50) NOT NULL UNIQUE,
  representative_name VARCHAR(100) NOT NULL,

  -- æ‹…å½“è€…æƒ…å ±
  contact_name VARCHAR(100) NOT NULL,
  department VARCHAR(100),
  phone VARCHAR(20),
  email VARCHAR(255),

  -- æ‰€åœ¨åœ°
  address VARCHAR(255) NOT NULL,
  website_url VARCHAR(255),

  -- å¯¾å¿œã‚¨ãƒªã‚¢
  service_prefectures TEXT[],

  -- ç´¹ä»‹ã‚³ãƒ¼ãƒ‰
  referral_code VARCHAR(50) NOT NULL UNIQUE,

  -- ç™»éŒ²æƒ…å ±
  registration_mode VARCHAR(20)
    CHECK (registration_mode IN ('self', 'referral')),
  referrer_name VARCHAR(100),

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  is_active BOOLEAN NOT NULL DEFAULT true,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_real_estate_agents_referral_code ON real_estate_agents(referral_code);
CREATE INDEX idx_real_estate_agents_active ON real_estate_agents(is_active) WHERE is_active = true;
CREATE INDEX idx_real_estate_agents_license ON real_estate_agents(license_no);
```

**ã‚«ãƒ©ãƒ å®šç¾©**:

| # | ã‚«ãƒ©ãƒ å | å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---------|---|------|----------|------|
| 1 | id | UUID | NOT NULL | gen_random_uuid() | ä¸å‹•ç”£æ¥­è€…IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| 2 | company_name | VARCHAR(150) | NOT NULL | - | ä¼šç¤¾å |
| 3 | license_no | VARCHAR(50) | NOT NULL | - | å®…å»ºæ¥­å…è¨±ç•ªå· |
| 4 | representative_name | VARCHAR(100) | NOT NULL | - | ä»£è¡¨è€…å |
| 5 | contact_name | VARCHAR(100) | NOT NULL | - | æ‹…å½“è€…å |
| 6 | department | VARCHAR(100) | NULL | - | éƒ¨ç½² |
| 7 | phone | VARCHAR(20) | NULL | - | é›»è©±ç•ªå· |
| 8 | email | VARCHAR(255) | NULL | - | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| 9 | address | VARCHAR(255) | NOT NULL | - | ä½æ‰€ |
| 10 | website_url | VARCHAR(255) | NULL | - | Webã‚µã‚¤ãƒˆURL |
| 11 | service_prefectures | TEXT[] | NULL | - | å¯¾å¿œéƒ½é“åºœçœŒï¼ˆé…åˆ—ï¼‰ |
| 12 | referral_code | VARCHAR(50) | NOT NULL | - | ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ |
| 13 | registration_mode | VARCHAR(20) | NULL | - | ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ |
| 14 | referrer_name | VARCHAR(100) | NULL | - | ç´¹ä»‹è€…å |
| 15 | is_active | BOOLEAN | NOT NULL | true | æœ‰åŠ¹ãƒ•ãƒ©ã‚° |
| 16 | created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | ä½œæˆæ—¥æ™‚ |
| 17 | updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¥æ™‚ |

**åˆ¶ç´„**:
- **PRIMARY KEY**: `id`
- **UNIQUE**: `license_no`, `referral_code`
- **CHECK**: `registration_mode IN ('self', 'referral')`

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_real_estate_agents_referral_code`: referral_code
- `idx_real_estate_agents_active`: is_active WHERE is_active = true
- `idx_real_estate_agents_license`: license_no

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- referral_codeã¯è‡ªå‹•ç”Ÿæˆï¼ˆä¾‹ï¼šREA-XXXXXXï¼‰
- service_prefecturesã¯è¤‡æ•°é¸æŠå¯èƒ½ï¼ˆPostgreSQLé…åˆ—å‹ï¼‰
- license_noã¯å®…å»ºæ¥­å…è¨±ç•ªå·ã®å½¢å¼ãƒã‚§ãƒƒã‚¯æ¨å¥¨ï¼ˆä¾‹ï¼šæ±äº¬éƒ½çŸ¥äº‹(1)ç¬¬12345å·ï¼‰

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/realEstate.ts:9-20`, `src/types/realEstate.ts:29-34`

---

### 3.2 referrersï¼ˆç´¹ä»‹è€…ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `referrers`

**èª¬æ˜**: ä¸å‹•ç”£æ¥­è€…ä»¥å¤–ã®ç´¹ä»‹è€…ï¼ˆå€‹äººãƒ»æ³•äººï¼‰ã‚’ç®¡ç†ã€‚å ±é…¬è¨ˆç®—ã«ã‚‚ä½¿ç”¨ã€‚

**DDL**:
```sql
CREATE TABLE referrers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ç´¹ä»‹è€…ç¨®åˆ¥
  referrer_type VARCHAR(20) NOT NULL
    CHECK (referrer_type IN ('company', 'individual')),

  -- åŸºæœ¬æƒ…å ±
  display_name VARCHAR(100) NOT NULL,
  phone VARCHAR(20) NOT NULL,
  email VARCHAR(255) NOT NULL,
  address VARCHAR(255),

  -- ä¼šç¤¾æƒ…å ±ï¼ˆreferrer_type='company'ã®å ´åˆï¼‰
  company_name VARCHAR(150),
  department VARCHAR(100),
  billing_company_name VARCHAR(150),
  billing_address VARCHAR(255),
  billing_phone VARCHAR(20),
  billing_email VARCHAR(255),

  -- å€‹äººæƒ…å ±ï¼ˆreferrer_type='individual'ã®å ´åˆï¼‰
  full_name VARCHAR(100),
  full_name_kana VARCHAR(100),
  birth_date DATE,
  tax_category VARCHAR(30)
    CHECK (tax_category IN ('å€‹äººäº‹æ¥­ä¸»', 'çµ¦ä¸æ‰€å¾—è€…', 'å¹´é‡‘æ‰€å¾—è€…', 'ãã®ä»–')),
  withholding_tax BOOLEAN DEFAULT false,

  -- æŒ¯è¾¼å…ˆæƒ…å ±
  bank_code VARCHAR(10),
  branch_name VARCHAR(100),
  account_number VARCHAR(20),
  account_holder VARCHAR(100),

  -- è¦ç´„åŒæ„
  terms_accepted BOOLEAN NOT NULL DEFAULT false,
  terms_accepted_at TIMESTAMP,

  -- ç®¡ç†ãƒ•ãƒ©ã‚°
  is_admin BOOLEAN DEFAULT false,
  is_active BOOLEAN NOT NULL DEFAULT true,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_referrers_type ON referrers(referrer_type);
CREATE INDEX idx_referrers_email ON referrers(email);
CREATE INDEX idx_referrers_active ON referrers(is_active) WHERE is_active = true;
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(27ã‚«ãƒ©ãƒ  - è©³ç´°ã¯çœç•¥)*

**åˆ¶ç´„**:
- **PRIMARY KEY**: `id`
- **CHECK**: `referrer_type IN ('company', 'individual')`
- **CHECK**: `tax_category IN ('å€‹äººäº‹æ¥­ä¸»', 'çµ¦ä¸æ‰€å¾—è€…', 'å¹´é‡‘æ‰€å¾—è€…', 'ãã®ä»–')`

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_referrers_type`: referrer_type
- `idx_referrers_email`: email
- `idx_referrers_active`: is_active WHERE is_active = true

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- referrer_type='company'ã®å ´åˆã€company_nameå¿…é ˆ
- referrer_type='individual'ã®å ´åˆã€full_nameå¿…é ˆ
- æŒ¯è¾¼å…ˆæƒ…å ±ã¯å ±é…¬æ”¯æ‰•ã„ã«ä½¿ç”¨
- terms_acceptedãŒfalseã®å ´åˆã€æ¡ˆä»¶ç´¹ä»‹ä¸å¯

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/referral.ts:79-92`, `src/types/referral.ts:18-27`, `src/types/referral.ts:48-74`

---

### 3.3 referral_casesï¼ˆç´¹ä»‹æ¡ˆä»¶ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `referral_cases`

**èª¬æ˜**: ç´¹ä»‹è€…çµŒç”±ã®æ¡ˆä»¶ã‚’ç®¡ç†ã€‚æˆç´„æ™‚ã®å ±é…¬è¨ˆç®—ã«ä½¿ç”¨ã€‚

**DDL**:
```sql
CREATE TABLE referral_cases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ç´¹ä»‹è€…
  referrer_id UUID NOT NULL REFERENCES referrers(id),
  referrer_type VARCHAR(20) NOT NULL
    CHECK (referrer_type IN ('company', 'individual')),

  -- è¦‹ç©ä¾é ¼ï¼ˆç´ä»˜ã‘ï¼‰
  quote_request_id UUID REFERENCES quote_requests(id),

  -- é¡§å®¢æƒ…å ±ï¼ˆåŒ¿ååŒ–ï¼‰
  customer_anonymous_id VARCHAR(100),
  customer_area VARCHAR(100),
  moving_date DATE,

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status VARCHAR(20) NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'in_progress', 'completed', 'cancelled', 'expired')),

  -- æˆç´„æƒ…å ±
  contract_amount INT CHECK (contract_amount >= 0),
  commission_amount INT CHECK (commission_amount >= 0),
  commission_rate DECIMAL(5,2),

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  application_date DATE NOT NULL DEFAULT CURRENT_DATE,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_referral_cases_referrer ON referral_cases(referrer_id);
CREATE INDEX idx_referral_cases_status ON referral_cases(status);
CREATE INDEX idx_referral_cases_application_date ON referral_cases(application_date DESC);
CREATE INDEX idx_referral_cases_quote_request ON referral_cases(quote_request_id);
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(14ã‚«ãƒ©ãƒ )*

**åˆ¶ç´„**:
- **PRIMARY KEY**: `id`
- **FOREIGN KEY**: `referrer_id` â†’ `referrers(id)`
- **FOREIGN KEY**: `quote_request_id` â†’ `quote_requests(id)`
- **CHECK**: `referrer_type IN ('company', 'individual')`
- **CHECK**: `status IN ('pending', 'in_progress', 'completed', 'cancelled', 'expired')`
- **CHECK**: `contract_amount >= 0`, `commission_amount >= 0`

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- status='completed'ã®å ´åˆã€commission_amountè‡ªå‹•è¨ˆç®—
- commission_rateã¯ç´¹ä»‹è€…ã”ã¨ã«ç•°ãªã‚‹è¨­å®šãŒå¯èƒ½ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5-10%ï¼‰
- customer_anonymous_idã¯ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã®ãŸã‚é¡§å®¢IDã‚’ãƒãƒƒã‚·ãƒ¥åŒ–

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/referral.ts:106-132`

---

## 4. è¦‹ç©ä¾é ¼ãƒ•ãƒ­ãƒ¼

### 4.1 quote_requestsï¼ˆè¦‹ç©ä¾é ¼ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `quote_requests`

**èª¬æ˜**: é¡§å®¢ã‹ã‚‰ã®è¦‹ç©ä¾é ¼ã‚’ç®¡ç†ã€‚ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã€‚

**DDL**:
```sql
CREATE TABLE quote_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- é¡§å®¢æƒ…å ±
  customer_last_name VARCHAR(100) NOT NULL,
  customer_first_name VARCHAR(100) NOT NULL,
  customer_last_name_kana VARCHAR(100) NOT NULL,
  customer_first_name_kana VARCHAR(100) NOT NULL,
  customer_phone VARCHAR(20) NOT NULL,
  customer_email VARCHAR(255) NOT NULL,

  -- ç´¹ä»‹å…ƒæƒ…å ±
  referrer_agent_id UUID REFERENCES real_estate_agents(id),
  referral_id VARCHAR(100),

  -- å¼•è¶Šã—ç¨®åˆ¥
  move_type VARCHAR(20) NOT NULL CHECK (move_type IN ('single', 'family')),

  -- ç™ºåœ°æƒ…å ±
  from_postal_code VARCHAR(10),
  from_prefecture VARCHAR(50) NOT NULL,
  from_city VARCHAR(100) NOT NULL,
  from_address_detail VARCHAR(255),
  property_type_from VARCHAR(30),
  floor_from INT,
  has_elevator_from BOOLEAN,

  -- ç€åœ°æƒ…å ±
  to_postal_code VARCHAR(10),
  to_prefecture VARCHAR(50) NOT NULL,
  to_city VARCHAR(100) NOT NULL,
  to_address_detail VARCHAR(255),
  property_type_to VARCHAR(30),
  floor_to INT,
  has_elevator_to BOOLEAN,

  -- å¸Œæœ›æ—¥æ™‚ï¼ˆ3å€™è£œå¯¾å¿œï¼‰
  preferred_date_1 DATE,
  preferred_time_slot_1 VARCHAR(50),
  preferred_date_2 DATE,
  preferred_time_slot_2 VARCHAR(50),
  preferred_date_3 DATE,
  preferred_time_slot_3 VARCHAR(50),

  -- ä¾é ¼ç®¡ç†
  status VARCHAR(20) NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'answered', 'expired')),
  priority VARCHAR(20) DEFAULT 'medium'
    CHECK (priority IN ('high', 'medium', 'low')),
  source_type VARCHAR(50) NOT NULL,

  -- æ—¥ä»˜ç®¡ç†
  request_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  deadline DATE NOT NULL,

  -- æ¢±åŒ…è³‡æé…é€ç®¡ç†
  packing_delivery BOOLEAN DEFAULT false,
  packing_deadline DATE,
  packing_delivery_completed BOOLEAN DEFAULT false,

  -- å‚™è€ƒ
  notes TEXT,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_quote_requests_status ON quote_requests(status);
CREATE INDEX idx_quote_requests_request_date ON quote_requests(request_date DESC);
CREATE INDEX idx_quote_requests_referrer ON quote_requests(referrer_agent_id);
CREATE INDEX idx_quote_requests_customer_email ON quote_requests(customer_email);
CREATE INDEX idx_quote_requests_preferred_date ON quote_requests(preferred_date_1);
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(47ã‚«ãƒ©ãƒ  - ä¸»è¦ã‚«ãƒ©ãƒ ã®ã¿æŠœç²‹)*

| # | ã‚«ãƒ©ãƒ å | èª¬æ˜ | æ ¹æ‹  |
|---|---------|------|------|
| 1 | id | è¦‹ç©ä¾é ¼ID | - |
| 2-5 | customer_*_name/kana | é¡§å®¢åãƒ»ã‚«ãƒŠ | common.ts:11-16 |
| 6-7 | customer_phone/email | é›»è©±ãƒ»ãƒ¡ãƒ¼ãƒ« | common.ts:18-20 |
| 8 | referrer_agent_id | ç´¹ä»‹å…ƒä¸å‹•ç”£æ¥­è€…ID | common.ts:111 |
| 10 | move_type | å¼•è¶Šã—ç¨®åˆ¥ï¼ˆsingle/familyï¼‰ | common.ts:31 |
| 11-17 | from_* | ç™ºåœ°æƒ…å ± | common.ts:41-51 |
| 18-24 | to_* | ç€åœ°æƒ…å ± | common.ts:42-51 |
| 25-30 | preferred_date_*/time_slot_* | å¸Œæœ›æ—¥æ™‚ï¼ˆ3å€™è£œï¼‰ | common.ts:206-210 |
| 31 | status | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | common.ts:109 |
| 34 | source_type | ä¾é ¼å…ƒç¨®åˆ¥ | common.ts:107 |

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- deadlineã¯é€šå¸¸ã€request_dateã‹ã‚‰3æ—¥å¾Œ
- source_typeå€¤ä¾‹ï¼šsyncmoving/suumo/manual/agent
- è¤‡æ•°å¸Œæœ›æ—¥å¯¾å¿œï¼ˆæœ€å¤§3ä»¶ï¼‰
- preferred_time_slotå€¤: morning/afternoon/evening/nightç­‰

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/common.ts:91-112`, `src/types/forms/index.ts:197-222`

---

### 4.2 moving_itemsï¼ˆå¼•è¶Šã—è·ç‰©ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `moving_items`

**èª¬æ˜**: è¦‹ç©ä¾é ¼ã«ç´ã¥ãè·ç‰©æƒ…å ±ã‚’ç®¡ç†ã€‚

**DDL**:
```sql
CREATE TABLE moving_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  quote_request_id UUID NOT NULL REFERENCES quote_requests(id) ON DELETE CASCADE,
  category VARCHAR(50) NOT NULL,
  item_name VARCHAR(100) NOT NULL,
  quantity INT NOT NULL CHECK (quantity > 0),
  points_per_unit INT NOT NULL CHECK (points_per_unit >= 0),
  total_points INT GENERATED ALWAYS AS (quantity * points_per_unit) STORED,
  additional_cost INT DEFAULT 0,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_moving_items_request ON moving_items(quote_request_id);
CREATE INDEX idx_moving_items_category ON moving_items(category);
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(9ã‚«ãƒ©ãƒ )*

**åˆ¶ç´„**:
- **PRIMARY KEY**: `id`
- **FOREIGN KEY**: `quote_request_id` â†’ `quote_requests(id)` ON DELETE CASCADE
- **CHECK**: `quantity > 0`, `points_per_unit >= 0`
- **GENERATED**: `total_points AS (quantity * points_per_unit)`

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- total_pointsã¯è‡ªå‹•è¨ˆç®—ï¼ˆGENERATED COLUMNï¼‰
- item_nameã¯å°†æ¥çš„ã«item_mastersã¨é€£æºäºˆå®š
- categoryã®æ¨™æº–å€¤: furniture/appliances/boxes/clothing/books/electronicsç­‰

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/common.ts:58-71`, `src/types/items-unified.ts:7-14`

---

### 4.3 quotesï¼ˆè¦‹ç©ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `quotes`

**èª¬æ˜**: å¼•è¶Šã—æ¥­è€…ãŒæä¾›ã™ã‚‹è¦‹ç©æƒ…å ±ã‚’ç®¡ç†ã€‚

**DDL**:
```sql
CREATE TABLE quotes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  quote_request_id UUID NOT NULL REFERENCES quote_requests(id) ON DELETE CASCADE,
  moving_company_id UUID NOT NULL REFERENCES moving_companies(id),

  -- è¦‹ç©ã‚¿ã‚¤ãƒ—
  quote_type VARCHAR(20) NOT NULL DEFAULT 'quote'
    CHECK (quote_type IN ('quote', 'unavailable')),

  -- æ–™é‡‘æƒ…å ±ï¼ˆè¦‹ç©å¯èƒ½æ™‚ã®ã¿ï¼‰
  base_price INT CHECK (base_price >= 0),
  discount_amount INT DEFAULT 0 CHECK (discount_amount >= 0),
  tax_amount INT CHECK (tax_amount >= 0),
  total_price INT CHECK (total_price >= 0),

  -- æ–™é‡‘å†…è¨³ï¼ˆè¦‹ç©ç®—å‡ºæ ¹æ‹ ï¼‰
  breakdown_base_price INT,
  breakdown_distance_price INT,
  breakdown_option_price INT,
  breakdown_total_points INT,
  recommended_truck VARCHAR(50),

  -- èª¿æ•´æƒ…å ±
  adjustment_amount INT DEFAULT 0,
  adjustment_rate DECIMAL(5,2) DEFAULT 0.00,
  adjustment_reason_type VARCHAR(30)
    CHECK (adjustment_reason_type IN ('competitive', 'urgent', 'repeat_customer',
           'volume_discount', 'difficulty', 'other')),
  adjustment_reason_desc TEXT,

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status VARCHAR(20) NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'quoted', 'accepted', 'rejected', 'expired', 'completed')),

  -- æœ‰åŠ¹æœŸé™
  valid_until DATE,

  -- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  response_comment TEXT,
  message_to_customer TEXT,

  -- å›ç­”è€…æƒ…å ±
  responded_at TIMESTAMP,
  responded_by VARCHAR(100),

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  -- ãƒã‚§ãƒƒã‚¯åˆ¶ç´„ï¼šè¦‹ç©ã‚¿ã‚¤ãƒ—ãŒquoteã®å ´åˆã¯æ–™é‡‘å¿…é ˆ
  CONSTRAINT check_quote_has_price
    CHECK (quote_type = 'unavailable' OR (base_price IS NOT NULL AND total_price IS NOT NULL))
);

CREATE INDEX idx_quotes_request ON quotes(quote_request_id);
CREATE INDEX idx_quotes_company ON quotes(moving_company_id);
CREATE INDEX idx_quotes_status ON quotes(status);
CREATE INDEX idx_quotes_created_at ON quotes(created_at DESC);
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(27ã‚«ãƒ©ãƒ )*

**åˆ¶ç´„**:
- **PRIMARY KEY**: `id`
- **FOREIGN KEY**: `quote_request_id` â†’ `quote_requests(id)` ON DELETE CASCADE
- **FOREIGN KEY**: `moving_company_id` â†’ `moving_companies(id)`
- **CHECK**: å¤šæ•°ï¼ˆä¸Šè¨˜DDLå‚ç…§ï¼‰
- **CONSTRAINT**: `check_quote_has_price` - è¦‹ç©å¯èƒ½æ™‚ã¯æ–™é‡‘å¿…é ˆ

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- quote_type='unavailable'ã®å ´åˆã€æ–™é‡‘æƒ…å ±ã¯NULL
- valid_untilã¯é€šå¸¸ã€è¦‹ç©æå‡ºæ—¥ã‹ã‚‰1é€±é–“
- adjustment_amountã¯å€¤å¼•ããƒ»å€¤å¢—ã—ã®èª¿æ•´é¡
- statusã®é·ç§»: pending â†’ quoted â†’ accepted â†’ completed

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/common.ts:117-140`, `src/types/business/index.ts:84-103`, `src/types/pricing.ts:143-157`

---

### 4.4 quote_optionsï¼ˆè¦‹ç©ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `quote_options`

**èª¬æ˜**: è¦‹ç©ã«é¸æŠã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç®¡ç†ï¼ˆä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã€‚

**DDL**:
```sql
CREATE TABLE quote_options (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  quote_id UUID NOT NULL REFERENCES quotes(id) ON DELETE CASCADE,
  option_id UUID NOT NULL REFERENCES options(id),

  -- é¸æŠæ™‚ã®æƒ…å ±
  quantity INT NOT NULL DEFAULT 1 CHECK (quantity > 0),
  unit_price INT NOT NULL CHECK (unit_price >= 0),
  total_price INT NOT NULL CHECK (total_price >= 0),

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  CONSTRAINT uq_quote_option UNIQUE (quote_id, option_id)
);

CREATE INDEX idx_quote_options_quote ON quote_options(quote_id);
CREATE INDEX idx_quote_options_option ON quote_options(option_id);
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(7ã‚«ãƒ©ãƒ )*

**åˆ¶ç´„**:
- **PRIMARY KEY**: `id`
- **FOREIGN KEY**: `quote_id` â†’ `quotes(id)` ON DELETE CASCADE
- **FOREIGN KEY**: `option_id` â†’ `options(id)`
- **UNIQUE**: (quote_id, option_id)
- **CHECK**: `quantity > 0`, `unit_price >= 0`, `total_price >= 0`

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- åŒä¸€è¦‹ç©ã«åŒã˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯1å›ã®ã¿é¸æŠå¯èƒ½
- unit_priceã¯é¸æŠæ™‚ç‚¹ã®options.priceã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
- total_price = unit_price Ã— quantity

---

## 5. æ¡ˆä»¶ç®¡ç†

### 5.1 jobsï¼ˆæ¡ˆä»¶ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `jobs`

**èª¬æ˜**: å—æ³¨ç¢ºå®šã—ãŸå¼•è¶Šã—æ¡ˆä»¶ã‚’ç®¡ç†ã€‚å®Ÿä½œæ¥­ã®ç®¡ç†ã«ä½¿ç”¨ã€‚

**DDL**: *(é•·ã„ãŸã‚ä¸€éƒ¨çœç•¥)*

```sql
CREATE TABLE jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- å‚ç…§æƒ…å ±
  quote_id UUID NOT NULL REFERENCES quotes(id),
  quote_request_id UUID REFERENCES quote_requests(id),
  moving_company_id UUID NOT NULL REFERENCES moving_companies(id),
  referrer_agent_id UUID REFERENCES real_estate_agents(id),

  -- é¡§å®¢æƒ…å ±ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
  customer_name VARCHAR(100) NOT NULL,
  customer_phone VARCHAR(20) NOT NULL,
  customer_email VARCHAR(255),
  from_address VARCHAR(500) NOT NULL,
  to_address VARCHAR(500) NOT NULL,

  -- ä½œæ¥­æƒ…å ±
  total_points INT,
  distance DECIMAL(10,2),

  -- ä½œæ¥­æ—¥æ™‚
  scheduled_date DATE NOT NULL,
  scheduled_start_time TIMESTAMP,
  scheduled_end_time TIMESTAMP,
  time_slot VARCHAR(50),
  estimated_duration INT,

  actual_start_time TIMESTAMP,
  actual_end_time TIMESTAMP,

  -- ãƒªã‚½ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦
  crew_size INT,
  truck_count INT,

  -- é¸æŠã‚ªãƒ—ã‚·ãƒ§ãƒ³
  selected_options JSONB,

  -- æ”¯æ‰•æƒ…å ±
  payment_method VARCHAR(20) CHECK (payment_method IN ('cash', 'card', 'transfer', 'invoice')),
  payment_status VARCHAR(20) CHECK (payment_status IN ('pending', 'paid', 'partial', 'refunded')),
  payment_amount INT,
  payment_due_date DATE,
  contract_date DATE,

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status VARCHAR(20) NOT NULL DEFAULT 'scheduled'
    CHECK (status IN ('scheduled', 'in_progress', 'completed', 'cancelled', 'rescheduled')),

  -- å‚™è€ƒ
  notes TEXT,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_jobs_quote ON jobs(quote_id);
CREATE INDEX idx_jobs_request ON jobs(quote_request_id);
CREATE INDEX idx_jobs_company ON jobs(moving_company_id);
CREATE INDEX idx_jobs_scheduled_date ON jobs(scheduled_date);
CREATE INDEX idx_jobs_status ON jobs(status);
CREATE INDEX idx_jobs_referrer ON jobs(referrer_agent_id);
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(32ã‚«ãƒ©ãƒ )*

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- é¡§å®¢æƒ…å ±ã¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆå¤‰æ›´ã•ã‚Œã¦ã‚‚å±¥æ­´ä¿æŒï¼‰
- selected_optionsã¯JSONBå‹ã§æŸ”è»Ÿã«ä¿å­˜
- actual_start_time/end_timeã¯å®Ÿç¸¾è¨˜éŒ²ç”¨
- estimated_durationã¯åˆ†å˜ä½
- statusã®é·ç§»: scheduled â†’ in_progress â†’ completed

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/business/index.ts:189-201`, `src/types/shared.ts:101-146`

---

### 5.2 job_assignmentsï¼ˆæ¡ˆä»¶å‰²ã‚Šå½“ã¦ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `job_assignments`

**èª¬æ˜**: æ¡ˆä»¶ã«å¯¾ã™ã‚‹å¾“æ¥­å“¡ãƒ»ãƒˆãƒ©ãƒƒã‚¯ã®å‰²ã‚Šå½“ã¦ã‚’è©³ç´°ç®¡ç†ã€‚

**DDL**:
```sql
CREATE TABLE job_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  job_id UUID NOT NULL REFERENCES jobs(id) ON DELETE CASCADE,

  -- ãƒªã‚½ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦
  employee_id UUID REFERENCES employees(id),
  truck_id UUID REFERENCES trucks(id),

  -- å½¹å‰²
  assignment_type VARCHAR(20) NOT NULL
    CHECK (assignment_type IN ('driver', 'worker', 'leader')),

  -- ä½œæ¥­æ™‚é–“
  assigned_start_time TIMESTAMP NOT NULL,
  assigned_end_time TIMESTAMP NOT NULL,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  CONSTRAINT check_assignment_has_resource
    CHECK (employee_id IS NOT NULL OR truck_id IS NOT NULL)
);

CREATE INDEX idx_job_assignments_job ON job_assignments(job_id);
CREATE INDEX idx_job_assignments_employee ON job_assignments(employee_id);
CREATE INDEX idx_job_assignments_truck ON job_assignments(truck_id);
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(9ã‚«ãƒ©ãƒ )*

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- å°‘ãªãã¨ã‚‚å¾“æ¥­å“¡ã¾ãŸã¯ãƒˆãƒ©ãƒƒã‚¯ã®ã„ãšã‚Œã‹ãŒå¿…é ˆ
- assignment_typeãŒdriverã®å ´åˆã€employee_idå¿…é ˆ
- åŒä¸€jobã«å¯¾ã—ã¦è¤‡æ•°ã®å‰²ã‚Šå½“ã¦å¯èƒ½ï¼ˆè¤‡æ•°å¾“æ¥­å“¡ãƒ»è¤‡æ•°ãƒˆãƒ©ãƒƒã‚¯ï¼‰

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/shared.ts:149-154`

---

### 5.3 reviewsï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `reviews`

**èª¬æ˜**: æ¡ˆä»¶å®Œäº†å¾Œã®é¡§å®¢ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç®¡ç†ã€‚ã‚µãƒ¼ãƒ“ã‚¹å“è³ªå‘ä¸Šã«ä½¿ç”¨ã€‚

**DDL**:
```sql
CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- é–¢é€£æƒ…å ±
  job_id UUID NOT NULL REFERENCES jobs(id),
  customer_email VARCHAR(255),

  -- è©•ä¾¡
  rating INT NOT NULL CHECK (rating BETWEEN 1 AND 5),
  comment TEXT,

  -- æ¤œè¨¼ãƒ•ãƒ©ã‚°
  is_verified BOOLEAN DEFAULT false,

  -- ä¼šç¤¾ã‹ã‚‰ã®è¿”ä¿¡
  company_response TEXT,
  company_response_at TIMESTAMP,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_reviews_job ON reviews(job_id);
CREATE INDEX idx_reviews_rating ON reviews(rating);
CREATE INDEX idx_reviews_created_at ON reviews(created_at DESC);
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(10ã‚«ãƒ©ãƒ )*

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- ratingã¯1-5ã®æ•´æ•°
- is_verifiedãŒtrueã®å ´åˆã€å®Ÿéš›ã®é¡§å®¢ã«ã‚ˆã‚‹æŠ•ç¨¿ã¨ç¢ºèªæ¸ˆã¿
- å¹³å‡è©•ä¾¡ã®è¨ˆç®—æ™‚ã¯is_verified=trueã®ã¿ã‚’ä½¿ç”¨æ¨å¥¨

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/business/index.ts:211-233`

---

## 6. ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿

### 6.1 item_mastersï¼ˆè·ç‰©ãƒã‚¹ã‚¿ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `item_masters`

**èª¬æ˜**: è·ç‰©ã®æ¨™æº–æƒ…å ±ã‚’ç®¡ç†ã€‚æ–™é‡‘è¨ˆç®—ã®åŸºæº–ãƒ‡ãƒ¼ã‚¿ã€‚

**DDL**:
```sql
CREATE TABLE item_masters (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- åŸºæœ¬æƒ…å ±
  category VARCHAR(50) NOT NULL,
  name VARCHAR(100) NOT NULL UNIQUE,

  -- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
  default_points INT NOT NULL CHECK (default_points >= 0),
  default_additional_cost INT DEFAULT 0 CHECK (default_additional_cost >= 0),

  -- ã‚¢ã‚¤ãƒ†ãƒ å±æ€§
  typical_size VARCHAR(10),
  typical_weight INT,
  is_fragile BOOLEAN DEFAULT false,
  requires_disassembly BOOLEAN DEFAULT false,

  -- è¡¨ç¤ºé †ãƒ»æœ‰åŠ¹ãƒ•ãƒ©ã‚°
  display_order INT DEFAULT 0,
  is_active BOOLEAN NOT NULL DEFAULT true,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_item_masters_category ON item_masters(category);
CREATE INDEX idx_item_masters_active ON item_masters(is_active) WHERE is_active = true;
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(13ã‚«ãƒ©ãƒ )*

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- nameã¯å…¨ã‚¢ã‚¤ãƒ†ãƒ ã§ä¸€æ„ï¼ˆé‡è¤‡ä¸å¯ï¼‰
- typical_size: S/M/L/XL
- display_orderã¯å°ã•ã„é †ã«è¡¨ç¤º
- is_active=falseã®å ´åˆã€æ–°è¦è¦‹ç©ã«ã¯è¡¨ç¤ºã—ãªã„

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/pricing.ts:57-64`, `src/types/items-unified.ts:28-33`

---

### 6.2 pricing_rulesï¼ˆæ–™é‡‘ãƒ«ãƒ¼ãƒ«ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `pricing_rules`

**èª¬æ˜**: ãƒã‚¤ãƒ³ãƒˆãƒ»è·é›¢ã«åŸºã¥ãæ–™é‡‘è¨ˆç®—ãƒ«ãƒ¼ãƒ«ã‚’ç®¡ç†ã€‚

**DDL**:
```sql
CREATE TABLE pricing_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ãƒˆãƒ©ãƒƒã‚¯ç¨®åˆ¥ã¨é©ç”¨ç¯„å›²
  truck_type VARCHAR(30) NOT NULL
    CHECK (truck_type IN ('è»½ãƒˆãƒ©ãƒƒã‚¯', '2tã‚·ãƒ§ãƒ¼ãƒˆ', '2tãƒ­ãƒ³ã‚°', '4t', '10t')),
  min_point INT NOT NULL,
  max_point INT,

  -- æ–™é‡‘è¨­å®š
  base_price INT NOT NULL CHECK (base_price >= 0),
  price_per_km DECIMAL(10,2) CHECK (price_per_km >= 0),

  -- é©ç”¨æœŸé–“
  valid_from DATE NOT NULL DEFAULT CURRENT_DATE,
  valid_until DATE,

  -- æœ‰åŠ¹ãƒ•ãƒ©ã‚°
  is_active BOOLEAN NOT NULL DEFAULT true,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  CONSTRAINT uq_pricing_rule
    UNIQUE (truck_type, min_point, max_point, valid_from)
);

CREATE INDEX idx_pricing_rules_truck_type ON pricing_rules(truck_type);
CREATE INDEX idx_pricing_rules_active ON pricing_rules(is_active) WHERE is_active = true;
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(12ã‚«ãƒ©ãƒ )*

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- max_pointãŒNULLã®å ´åˆã€ä¸Šé™ãªã—
- åŒä¸€truck_typeãƒ»ãƒã‚¤ãƒ³ãƒˆç¯„å›²ãƒ»é–‹å§‹æ—¥ã®çµ„ã¿åˆã‚ã›ã¯ä¸€æ„
- valid_untilãŒNULLã®å ´åˆã€ç„¡æœŸé™æœ‰åŠ¹
- æ–™é‡‘è¨ˆç®—æ™‚ã¯æœ€æ–°ã®valid_fromï¼ˆç¾åœ¨æ—¥ä»¥å‰ï¼‰ã®ãƒ«ãƒ¼ãƒ«ã‚’ä½¿ç”¨

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/pricing.ts:69-75`, `src/lib/business-logic.ts:329-336`

---

### 6.3 optionsï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `options`

**èª¬æ˜**: è¦‹ç©ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ãƒã‚¹ã‚¿ã€‚

**DDL**:
```sql
CREATE TABLE options (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- åŸºæœ¬æƒ…å ±
  name VARCHAR(100) NOT NULL UNIQUE,
  label VARCHAR(100) NOT NULL,
  description TEXT,

  -- æ–™é‡‘è¨­å®š
  option_type VARCHAR(20) NOT NULL
    CHECK (option_type IN ('free', 'paid', 'individual', 'nonSupported')),
  price INT CHECK (price >= 0),
  unit VARCHAR(20),

  -- é©ç”¨æ¡ä»¶
  min_point INT,
  max_point INT,

  -- è¡¨ç¤ºè¨­å®š
  is_default BOOLEAN DEFAULT false,
  display_order INT DEFAULT 0,
  is_active BOOLEAN NOT NULL DEFAULT true,

  -- å‚™è€ƒ
  remarks TEXT,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_options_active ON options(is_active) WHERE is_active = true;
CREATE INDEX idx_options_type ON options(option_type);
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(15ã‚«ãƒ©ãƒ )*

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- option_typeã®æ„å‘³:
  - free: ç„¡æ–™ã‚ªãƒ—ã‚·ãƒ§ãƒ³
  - paid: æœ‰æ–™ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆä¾¡æ ¼å›ºå®šï¼‰
  - individual: å€‹åˆ¥è¦‹ç©ï¼ˆpriceã¯NULLï¼‰
  - nonSupported: éå¯¾å¿œ
- min_point/max_pointã§é©ç”¨æ¡ä»¶ã‚’åˆ¶é™å¯èƒ½
- is_defaultãŒtrueã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠçŠ¶æ…‹

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/pricing.ts:80-90`

---

### 6.4 season_rulesï¼ˆã‚·ãƒ¼ã‚ºãƒ³åŠ ç®—ãƒ«ãƒ¼ãƒ«ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `season_rules`

**èª¬æ˜**: ç¹å¿™æœŸï¼ˆGWã€ãŠç›†ã€å¹´æœ«å¹´å§‹ãªã©ï¼‰ã®æ–™é‡‘åŠ ç®—ãƒ«ãƒ¼ãƒ«ã‚’ç®¡ç†ã€‚

**DDL**:
```sql
CREATE TABLE season_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ãƒ«ãƒ¼ãƒ«å
  name VARCHAR(100) NOT NULL,
  description TEXT,

  -- é©ç”¨æœŸé–“
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,

  -- æ–™é‡‘è¨­å®š
  price_type VARCHAR(20) NOT NULL
    CHECK (price_type IN ('percentage', 'fixed')),
  price DECIMAL(10,2) NOT NULL CHECK (price >= 0),

  -- ç¹°ã‚Šè¿”ã—è¨­å®š
  is_recurring BOOLEAN DEFAULT false,
  recurring_type VARCHAR(20)
    CHECK (recurring_type IN ('yearly', 'monthly', 'weekly', 'none')),
  recurring_pattern JSONB,
  recurring_end_year INT,

  -- æœ‰åŠ¹ãƒ•ãƒ©ã‚°
  is_active BOOLEAN NOT NULL DEFAULT true,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_season_rules_dates ON season_rules(start_date, end_date);
CREATE INDEX idx_season_rules_active ON season_rules(is_active) WHERE is_active = true;
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(14ã‚«ãƒ©ãƒ )*

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- price_typeãŒpercentageã®å ´åˆã€priceã¯%ï¼ˆä¾‹ï¼š20.00 = 20%å¢—ï¼‰
- price_typeãŒfixedã®å ´åˆã€priceã¯å›ºå®šé¡ï¼ˆå††ï¼‰
- recurring_patternã®æ§‹é€ ä¾‹ï¼ˆJSONBï¼‰:
  ```json
  {
    "weekdays": [6, 0],  // åœŸæ—¥
    "monthlyPattern": "weekday"
  }
  ```
- è¤‡æ•°ãƒ«ãƒ¼ãƒ«ãŒé‡è¤‡ã—ãŸå ´åˆã¯åˆç®—

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/pricing.ts:28-52`

---

## 7. ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½

### 7.1 notificationsï¼ˆé€šçŸ¥ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ç‰©ç†å**: `notifications`

**èª¬æ˜**: ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ã‚’ç®¡ç†ï¼ˆãƒ¡ãƒ¼ãƒ«ãƒ»ã‚¢ãƒ—ãƒªå†…é€šçŸ¥ï¼‰ã€‚

**DDL**:
```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- å®›å…ˆ
  recipient_email VARCHAR(255) NOT NULL,
  recipient_type VARCHAR(20) NOT NULL
    CHECK (recipient_type IN ('customer', 'company', 'employee', 'agent')),

  -- é€šçŸ¥å†…å®¹
  notification_type VARCHAR(30) NOT NULL
    CHECK (notification_type IN ('quote_received', 'quote_accepted', 'quote_rejected',
                                 'job_scheduled', 'job_completed', 'payment_due',
                                 'review_received', 'system_maintenance')),
  title VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  data JSONB,

  -- å„ªå…ˆåº¦
  priority VARCHAR(20) NOT NULL DEFAULT 'normal'
    CHECK (priority IN ('low', 'normal', 'high', 'urgent')),

  -- çŠ¶æ…‹
  is_read BOOLEAN NOT NULL DEFAULT false,
  read_at TIMESTAMP,

  -- æœ‰åŠ¹æœŸé™
  expires_at TIMESTAMP,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notifications_recipient ON notifications(recipient_email, is_read);
CREATE INDEX idx_notifications_type ON notifications(notification_type);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);
```

**ã‚«ãƒ©ãƒ å®šç¾©**: *(13ã‚«ãƒ©ãƒ )*

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- expires_atã‚’éããŸé€šçŸ¥ã¯è‡ªå‹•çš„ã«å‰Šé™¤ã¾ãŸã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
- dataãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯é€šçŸ¥ã«é–¢é€£ã™ã‚‹è¿½åŠ æƒ…å ±ï¼ˆæ¡ˆä»¶IDç­‰ï¼‰ã‚’æ ¼ç´
- priorityãŒurgentã®å ´åˆã€å³åº§ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡
- é€šçŸ¥ã®ä¿æŒæœŸé–“: 30æ—¥ï¼ˆexpires_at = created_at + 30æ—¥ï¼‰

**æ ¹æ‹ ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/business/index.ts:236-259`

---

## ä»˜éŒ²

### A. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤ä¸€è¦§

| ãƒ†ãƒ¼ãƒ–ãƒ« | ã‚«ãƒ©ãƒ  | å€¤ |
|---------|-------|---|
| quote_requests | status | pending/answered/expired |
| quote_requests | priority | high/medium/low |
| quotes | status | pending/quoted/accepted/rejected/expired/completed |
| quotes | quote_type | quote/unavailable |
| jobs | status | scheduled/in_progress/completed/cancelled/rescheduled |
| jobs | payment_status | pending/paid/partial/refunded |
| employees | status | active/inactive/suspended |
| trucks | status | available/in_use/maintenance/inactive/retired |
| shifts | status | available/planned/assigned/booked/working/completed/cancelled/unavailable/overtime |
| referral_cases | status | pending/in_progress/completed/cancelled/expired |

### B. CHECKåˆ¶ç´„ä¸€è¦§

å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸»è¦ãªCHECKåˆ¶ç´„ã¯ä¸Šè¨˜DDLå‚ç…§ã€‚

### C. å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ä¸€è¦§

| å­ãƒ†ãƒ¼ãƒ–ãƒ« | å­ã‚«ãƒ©ãƒ  | è¦ªãƒ†ãƒ¼ãƒ–ãƒ« | è¦ªã‚«ãƒ©ãƒ  | ON DELETE |
|----------|---------|----------|---------|-----------|
| employees | moving_company_id | moving_companies | id | CASCADE |
| trucks | moving_company_id | moving_companies | id | CASCADE |
| shifts | employee_id | employees | id | CASCADE |
| shifts | job_id | jobs | id | SET NULL |
| shifts | truck_id | trucks | id | SET NULL |
| quote_requests | referrer_agent_id | real_estate_agents | id | - |
| moving_items | quote_request_id | quote_requests | id | CASCADE |
| quotes | quote_request_id | quote_requests | id | CASCADE |
| quotes | moving_company_id | moving_companies | id | - |
| quote_options | quote_id | quotes | id | CASCADE |
| quote_options | option_id | options | id | - |
| jobs | quote_id | quotes | id | - |
| jobs | moving_company_id | moving_companies | id | - |
| job_assignments | job_id | jobs | id | CASCADE |
| job_assignments | employee_id | employees | id | - |
| job_assignments | truck_id | trucks | id | - |
| reviews | job_id | jobs | id | - |
| referral_cases | referrer_id | referrers | id | - |
| referral_cases | quote_request_id | quote_requests | id | - |

---

## å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|----------|------|---------|
| 1.0.0 | 2025-01-24 | åˆç‰ˆä½œæˆ |

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ERå›³](./ER-DIAGRAM.md)
- [DDLã‚¹ã‚¯ãƒªãƒ—ãƒˆ](./ddl/)
- [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»](./MIGRATION-PLAN.md)
- [å‹å®šç¾©ã¨ã®å¯¾å¿œè¡¨](./TYPE-MAPPING.md)
